with cte as (

SELECT hitid_high,hitid_low,product_list,index as index1 ,seq as seq1, value as hit_product, to_varchar(split(value,';')[1])  as product_type, to_varchar(split(value,';')[5])  as prod_evars   --as index_1, split(value,';')[5] as product_list_1

    FROM staging_clickstream.stg_hit_data, LATERAL SPLIT_TO_TABLE(staging_clickstream.stg_hit_data.product_list, ',')

    limit 1000),

    --where hitid_high = '3603498663007682560' and hitid_low = '4619415696980347606'),

  cte2 as (

select hitid_high, hitid_low,hit_product, product_type, seq,index,   split(value, '=')[0] as eVar,split(value, '=')[1] as eVar_value   from cte ,lateral split_to_table (prod_evars,'|')),

 

cte3 as (

select * from cte2

    pivot ( max(evar_value) for evar in ('eVar1',      'eVar2', 'eVar3', 'eVar4', 'eVar5', 'eVar6', 'eVar7', 'eVar8', 'eVar9',                'eVar10',              'eVar11',              'eVar12',              'eVar13',              'eVar14',              'eVar15',              'eVar16',                'eVar17',              'eVar18',              'eVar19',              'eVar20',              'eVar21',              'eVar22',              'eVar23',                'eVar24',              'eVar25',              'eVar26',              'eVar27',              'eVar28',              'eVar29',              'eVar30',                'eVar31',              'eVar32',              'eVar33',              'eVar34',              'eVar35',              'eVar36',              'eVar37',                'eVar38',              'eVar39',              'eVar40',              'eVar41',              'eVar42',              'eVar43',              'eVar44',                'eVar45',              'eVar46',              'eVar47',              'eVar48',              'eVar49',              'eVar50',              'eVar51',                'eVar52',              'eVar53',              'eVar54',              'eVar55',              'eVar56',              'eVar57',              'eVar58',                'eVar59',              'eVar60',              'eVar61',              'eVar62',              'eVar63',              'eVar64',              'eVar65',                'eVar66',              'eVar67',              'eVar68',              'eVar69',              'eVar70',              'eVar71',              'eVar72',                'eVar73',              'eVar74',              'eVar75',              'eVar76',              'eVar77',              'eVar78',              'eVar79',                'eVar80',              'eVar81',              'eVar82',              'eVar83',              'eVar84',              'eVar85',              'eVar86',                'eVar87',              'eVar88',              'eVar89',              'eVar90',              'eVar91',              'eVar92',              'eVar93',                'eVar94',              'eVar95',              'eVar96',              'eVar97',              'eVar98',              'eVar99',              'eVar100',                'eVar101',            'eVar102',            'eVar103',            'eVar104',            'eVar105',            'eVar106',            'eVar107',                'eVar108',            'eVar109',            'eVar110',            'eVar111',            'eVar112',            'eVar113',            'eVar114',                'eVar115',            'eVar116',            'eVar117',            'eVar118',            'eVar119',            'eVar120',            'eVar121',                'eVar122',            'eVar123',            'eVar124',            'eVar125',            'eVar126',            'eVar127',            'eVar128',                'eVar129',            'eVar130',            'eVar131',            'eVar132',            'eVar133',            'eVar134',            'eVar135',                'eVar136',            'eVar137',            'eVar138',            'eVar139',            'eVar140',            'eVar141',            'eVar142',                'eVar143',            'eVar144',            'eVar145',            'eVar146',            'eVar147',            'eVar148',            'eVar149',                'eVar150',            'eVar151',            'eVar152',            'eVar153',            'eVar154',            'eVar155',            'eVar156',                'eVar157',            'eVar158',            'eVar159',            'eVar160',            'eVar161',            'eVar162',            'eVar163',                'eVar164',            'eVar165',            'eVar166',            'eVar167',            'eVar168',            'eVar169',            'eVar170',                'eVar171',            'eVar172',            'eVar173',            'eVar174',            'eVar175',            'eVar176',            'eVar177',                'eVar178',            'eVar179',            'eVar180',            'eVar181',            'eVar182',            'eVar183',            'eVar184',                'eVar185',            'eVar186',            'eVar187',            'eVar188',            'eVar189',            'eVar190',            'eVar191',                'eVar192',            'eVar193',            'eVar194',            'eVar195',            'eVar196',            'eVar197',            'eVar198',                'eVar199',            'eVar200',            'eVar201',            'eVar202',            'eVar203',            'eVar204',            'eVar205',                'eVar206',            'eVar207',            'eVar208',            'eVar209',            'eVar210',            'eVar211',            'eVar212',                'eVar213',            'eVar214',            'eVar215',            'eVar216',            'eVar217',            'eVar218',            'eVar219',                'eVar220',            'eVar221',            'eVar222',            'eVar223',            'eVar224',            'eVar225',            'eVar226',                'eVar227',            'eVar228',            'eVar229',            'eVar230',            'eVar231',            'eVar232',            'eVar233',                'eVar234',            'eVar235',            'eVar236',            'eVar237',            'eVar238',            'eVar239',            'eVar240',                'eVar241',            'eVar242',            'eVar243',            'eVar244',            'eVar245',            'eVar246',            'eVar247',                'eVar248',            'eVar249',            'eVar250',            'eVar251',            'eVar252',            'eVar253',            'eVar254',                'eVar255',            'eVar256',            'eVar257',            'eVar258',            'eVar259',            'eVar260',            'eVar261',                'eVar262',            'eVar263',            'eVar264',            'eVar265',            'eVar266',            'eVar267',            'eVar268',                'eVar269',            'eVar270')) as p order by hitid_high,hitid_low,hit_product,product_type)

 

--select * from cte3;

   

    select hitid_high,hitid_low, hit_product, product_type, seq,max("'eVar1'"),       max("'eVar2'"), max("'eVar3'"),                max("'eVar4'"), max("'eVar5'"), max("'eVar6'"), max("'eVar7'"), max("'eVar8'"), max("'eVar9'"),                max("'eVar10'"),               max("'eVar11'"),               max("'eVar12'"),               max("'eVar13'"),                max("'eVar14'"),               max("'eVar15'"),               max("'eVar16'"),               max("'eVar17'"),                max("'eVar18'"),               max("'eVar19'"),               max("'eVar20'"),               max("'eVar21'"),                max("'eVar22'"),               max("'eVar23'"),               max("'eVar24'"),               max("'eVar25'"),                max("'eVar26'"),               max("'eVar27'"),               max("'eVar28'"),               max("'eVar29'"),                max("'eVar30'"),               max("'eVar31'"),               max("'eVar32'"),               max("'eVar33'"),                max("'eVar34'"),               max("'eVar35'"),               max("'eVar36'"),               max("'eVar37'"),                max("'eVar38'"),               max("'eVar39'"),               max("'eVar40'"),               max("'eVar41'"),                max("'eVar42'"),               max("'eVar43'"),               max("'eVar44'"),               max("'eVar45'"),                max("'eVar46'"),               max("'eVar47'"),               max("'eVar48'"),               max("'eVar49'"),                max("'eVar50'"),               max("'eVar51'"),               max("'eVar52'"),               max("'eVar53'"),                max("'eVar54'"),               max("'eVar55'"),               max("'eVar56'"),               max("'eVar57'"),                max("'eVar58'"),               max("'eVar59'"),               max("'eVar60'"),               max("'eVar61'"),                max("'eVar62'"),               max("'eVar63'"),               max("'eVar64'"),               max("'eVar65'"),                max("'eVar66'"),               max("'eVar67'"),               max("'eVar68'"),               max("'eVar69'"),                max("'eVar70'"),               max("'eVar71'"),               max("'eVar72'"),               max("'eVar73'"),                max("'eVar74'"),               max("'eVar75'"),               max("'eVar76'"),               max("'eVar77'"),                max("'eVar78'"),               max("'eVar79'"),               max("'eVar80'"),               max("'eVar81'"),                max("'eVar82'"),               max("'eVar83'"),               max("'eVar84'"),               max("'eVar85'"),                max("'eVar86'"),               max("'eVar87'"),               max("'eVar88'"),               max("'eVar89'"),                max("'eVar90'"),               max("'eVar91'"),               max("'eVar92'"),               max("'eVar93'"),                max("'eVar94'"),               max("'eVar95'"),               max("'eVar96'"),               max("'eVar97'"),                max("'eVar98'"),               max("'eVar99'"),               max("'eVar100'"),            max("'eVar101'"),                max("'eVar102'"),            max("'eVar103'"),            max("'eVar104'"),            max("'eVar105'"),                max("'eVar106'"),            max("'eVar107'"),            max("'eVar108'"),            max("'eVar109'"),                max("'eVar110'"),            max("'eVar111'"),            max("'eVar112'"),            max("'eVar113'"),                max("'eVar114'"),            max("'eVar115'"),            max("'eVar116'"),            max("'eVar117'"),                max("'eVar118'"),            max("'eVar119'"),            max("'eVar120'"),            max("'eVar121'"),                max("'eVar122'"),            max("'eVar123'"),            max("'eVar124'"),            max("'eVar125'"),                max("'eVar126'"),            max("'eVar127'"),            max("'eVar128'"),            max("'eVar129'"),                max("'eVar130'"),            max("'eVar131'"),            max("'eVar132'"),            max("'eVar133'"),                max("'eVar134'"),            max("'eVar135'"),            max("'eVar136'"),            max("'eVar137'"),                max("'eVar138'"),            max("'eVar139'"),            max("'eVar140'"),            max("'eVar141'"),                max("'eVar142'"),            max("'eVar143'"),            max("'eVar144'"),            max("'eVar145'"),                max("'eVar146'"),            max("'eVar147'"),            max("'eVar148'"),            max("'eVar149'"),                max("'eVar150'"),            max("'eVar151'"),            max("'eVar152'"),            max("'eVar153'"),                max("'eVar154'"),            max("'eVar155'"),            max("'eVar156'"),            max("'eVar157'"),                max("'eVar158'"),            max("'eVar159'"),            max("'eVar160'"),            max("'eVar161'"),                max("'eVar162'"),            max("'eVar163'"),            max("'eVar164'"),            max("'eVar165'"),                max("'eVar166'"),            max("'eVar167'"),            max("'eVar168'"),            max("'eVar169'"),                max("'eVar170'"),            max("'eVar171'"),            max("'eVar172'"),            max("'eVar173'"),                max("'eVar174'"),            max("'eVar175'"),            max("'eVar176'"),            max("'eVar177'"),                max("'eVar178'"),            max("'eVar179'"),            max("'eVar180'"),            max("'eVar181'"),                max("'eVar182'"),            max("'eVar183'"),            max("'eVar184'"),            max("'eVar185'"),                max("'eVar186'"),            max("'eVar187'"),            max("'eVar188'"),            max("'eVar189'"),                max("'eVar190'"),            max("'eVar191'"),            max("'eVar192'"),            max("'eVar193'"),                max("'eVar194'"),            max("'eVar195'"),            max("'eVar196'"),            max("'eVar197'"),                max("'eVar198'"),            max("'eVar199'"),            max("'eVar200'"),            max("'eVar201'"),                max("'eVar202'"),            max("'eVar203'"),            max("'eVar204'"),            max("'eVar205'"),                max("'eVar206'"),            max("'eVar207'"),            max("'eVar208'"),            max("'eVar209'"),                max("'eVar210'"),            max("'eVar211'"),            max("'eVar212'"),            max("'eVar213'"),                max("'eVar214'"),            max("'eVar215'"),            max("'eVar216'"),            max("'eVar217'"),                max("'eVar218'"),            max("'eVar219'"),            max("'eVar220'"),            max("'eVar221'"),                max("'eVar222'"),            max("'eVar223'"),            max("'eVar224'"),            max("'eVar225'"),                max("'eVar226'"),            max("'eVar227'"),            max("'eVar228'"),            max("'eVar229'"),                max("'eVar230'"),            max("'eVar231'"),            max("'eVar232'"),            max("'eVar233'"),                max("'eVar234'"),            max("'eVar235'"),            max("'eVar236'"),            max("'eVar237'"),                max("'eVar238'"),            max("'eVar239'"),            max("'eVar240'"),            max("'eVar241'"),                max("'eVar242'"),            max("'eVar243'"),            max("'eVar244'"),            max("'eVar245'"),                max("'eVar246'"),            max("'eVar247'"),            max("'eVar248'"),            max("'eVar249'"),                max("'eVar250'"),            max("'eVar251'"),            max("'eVar252'"),            max("'eVar253'"),                max("'eVar254'"),            max("'eVar255'"),            max("'eVar256'"),            max("'eVar257'"),                max("'eVar258'"),            max("'eVar259'"),            max("'eVar260'"),            max("'eVar261'"),                max("'eVar262'"),            max("'eVar263'"),            max("'eVar264'"),            max("'eVar265'"),                max("'eVar266'"),            max("'eVar267'"),            max("'eVar268'"),            max("'eVar269'"),                max("'eVar270'")

    from cte3

    group by hitid_high,hitid_low, hit_product, product_type, seq
